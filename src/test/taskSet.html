<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="layui-fluid">

    <form class='layui-form' id="formData"></form>

    <table class="layui-hide" id="data">
        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
                <button class="layui-btn pear-btn pear-btn-primary" id="search">刷新</button>
                <button type="button" class="layui-btn layui-btn-normal" onclick="openMediumWindow('updateForm')">添加
                </button>
            </div>
        </script>
        <script type="text/html" id="is_enable">
            <input type="checkbox" value="{{d.id}}" lay-skin="switch" lay-text="是|否" lay-filter="stateDemo" {{ d.status== 1 ? 'checked' : '' }}>
        </script>
        <script type="text/html" id="btn1">
            <button type="button" class="layui-btn pear-btn pear-btn-primary table-btn" onclick="openEdit('{{d.id}}')">编辑
            </button>
            <button type="button" class="layui-btn table-btn layui-btn-info" onclick="renderLog('{{d.id}}')">日志</button>
            <button class="layui-btn layui-btn-danger table-btn" onclick="deleteData('{{ d.id }}' ,'{{ d.title }}','/admin/taskSet/delete' )">删除</button>
        </script>

    </table>
</div>



<form class="layui-form layui-fluid form-style"  style="display: none" id="updateForm">
    <input type="hidden" name="id" value="" id="id">

    <div class="layui-form-item">
        <label class="layui-form-label">任务名称</label>
        <div class="layui-input-block">
            <input name="title" id="title" autocomplete="off" class="layui-input" type="text">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">任务类型</label>
        <div class="layui-input-block">
            <select name="type" id="type" class="task_select">
            </select>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">执行周期</label>
        <div class="layui-inline" style="width:90px">
            <select lay-filter="task_cycle" id="task_cycle" name="task_cycle">
                <option selected=""></option>
                <option value="1">每天</option>
                <option value="2">每小时</option>
                <option value="3">N小时</option>
                <option value="4">N分钟</option>
                <option value="5">N秒</option>
                <option value="6">每星期</option>
                <option value="7">每月</option>
                <option value="8">每年</option>
            </select>
        </div>
        <div style="display: inline-block" id="cron-box"></div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">调用目标</label>
        <div class="layui-input-block">
            <textarea placeholder="任务调用目标" name="target" id="target"  class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">任务备注</label>
        <div class="layui-input-block">
            <input name="remark" id="remark" autocomplete="off" class="layui-input" type="text">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">是否启用</label>
        <div class="layui-input-block">
            <input name="status" checked value="1" title="是" type="radio">
            <input name="status" value="0" title="否" type="radio">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">是否单次执行</label>
        <div class="layui-input-block">
            <input name="singleton" value="0" title="是" type="radio">
            <input name="singleton" checked value="1" title="否" type="radio">
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" type="button" onclick="AdminClass.submitData('/admin/taskSet/update','updateForm',this)">立即提交</button>
        </div>
    </div>
</form>


<form class="layui-form  layui-fluid form-style" style="display: none" id="task_log_form">
    <table class="layui-hide" id="task_log_table">
        <script type="text/html" id="return_code">
            {{#  if(d.return_code == 0){ }}
            <button type="button" class="layui-btn layui-btn-sm">成功</button>
            {{#  } else { }}
            <button type="button" class="layui-btn layui-btn-sm layui-border-red">失败</button>
            {{#  } }}
        </script>
    </table>
</form>


<script>
	layui.table.render({
		elem: '#data'
		, url: '/admin/taskSet/list'
		, toolbar: '#toolbarDemo'
		, method: "post",
		cellMinWidth: 80 //全局定义常规单元格的最小宽度
		, cols: [[
			{field: 'id', title: 'ID', width: 80}
			, {field: 'title', title: '任务标题',}
			, {field: 'rule_name', title: '执行周期', width: 180}
			, {field: 'target', title: '调用目标'}
			, {field: 'running_times', title: '运行次数', width: 90}
			, {field: 'last_running_time', title: '上次运行时间', width: 150}
			, {field: '', title: '启用', templet: "#is_enable", width: 110}
			, {field: 'create_time', title: '创建时间', sort: true, width: 165}
			, {field: '', title: '操作', templet: '#btn1', width: 250}
		]]
		, page: true,
	});

	// 渲染select
	AdminClass.renderSelect({
		'elem': '.task_select',
		'data': JSON.parse('{$task_select|raw}'),
	})

    //打开编辑窗口
	function openEdit(id) {
		Ajax.post('/admin/taskSet/get', {'id': id}).then(res => {
			if (res.code != 0) {
				layMsg(res.msg);
				return;
			}
			layer.open({
				type: 1,
				skin: 'layui-layer-rim',
				content: $('#updateForm'),
				title: '信息',
				area: ['90%', '90%'], //宽高
				zIndex:9999999,
				success: function () {
					let info = res.data;
					renderInfo(info);
					$('#updateForm').find("input[name='status'][value='" + info.status + "']").prop("checked", true);
					$('#updateForm').find("input[name='singleton'][value='" + info.singleton + "']").prop("checked", true);
					changeTask(info.task_cycle)
					renderInfo(info.cycle_rule)
					layui.form.render();
				},
				end: function () {
					$('#updateForm').hide();
					//关闭编辑弹窗清掉数据
					let clear_arr = ['id','title','type','rule','target','status','singleton','task_cycle'];
					for (let i in clear_arr){
						let field = clear_arr[i];
						$('#updateForm').find('#'+field).val('')
					}
					$('#cron-box').empty();
				}
			})
		})
	}

	//查看日志
	function renderLog(id) {

		layer.open({
			type: 1,
			skin: 'layui-layer-rim',
			content: $('#task_log_form'),
			title: '信息',
			area: ['90%', '90%'], //宽高
			zIndex:9999999,
			success: function () {
				table.render({
					elem: '#task_log_table'
					, url: '/admin/taskSet/getLog'
					, method: "post",
					where: {
						'id': id,
					},
					cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
					, cols: [[
						{field: 'id', title: 'ID', width: 80}
						, {field: 'return_code', title: '运行结果', templet: '#return_code', width: 100}
						, {field: 'target', title: '调用目标'}
						, {field: 'running_time', title: '执行耗时', width: 120}
						, {field: 'log', title: '执行日志'}
						, {field: 'create_time', title: '执行时间', sort: true, width: 165}
					]]
					, page: true,
				});
				layui.form.render();
			},
			end: function () {
				$('#task_log_form').hide();
			}
		})
	}

	//监听任务执行周期切换
	form.on("select(task_cycle)", function (data) {
		let value = parseInt(data.value);
		changeTask(value)
	})

    //任务类型切换
	function changeTask(value){
		let month = `
	    <div class="layui-inline">
            <div class="layui-input-inline" style="width: 80px">
                <input type="text" name="month" id="month" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">月</div>
        </div>
		`

		let week = `
		<div class="layui-inline">
            <div class="layui-input-inline" style="width: 80px">
                <select lay-filter="week" name="week">
                    <option value="1" selected="">周一</option>
                    <option value="2">周二</option>
                    <option value="3">周三</option>
                    <option value="4">周四</option>
                    <option value="5">周五</option>
                    <option value="6">周六</option>
                    <option value="0">周日</option>
                </select>
            </div>
        </div>
		`;

		let day = `
	    <div class="layui-inline">
            <div class="layui-input-inline" style="width: 80px">
                <input type="text" name="day" id="day" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">号</div>
        </div>
		`
		let hour = `
        <div class="layui-inline">
            <div class="layui-input-inline" style="width: 80px">
                <input type="text" name="hour" id="hour" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">点</div>
        </div>
        `
		let minute = `
          <div class="layui-inline">
            <div class="layui-input-inline" style="width: 80px">
                <input type="text" name="minute" id="minute" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">分</div>
        </div>
        `
		let second = `
        <div class="layui-inline">
            <div class="layui-input-inline" style="width:80px">
                <input type="text" name="second" id="second" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">秒</div>
        </div>
        `
		let insert_arr = [];
		switch (value) {
			case 1:
				insert_arr.push(hour,minute);
				break;
			case 2:
				insert_arr.push(minute);
				break;
			case 3:
				insert_arr.push(hour);
				insert_arr.push(minute);
				break;
			case 4:
				insert_arr.push(minute);
				break;
			case 5:
				insert_arr.push(second);
				break;
			case 6:
				insert_arr.push(week,hour,minute)
				break;
			case 7:
				insert_arr.push(day,hour,minute)
				break;
			case 8:
				insert_arr.push(month,day,hour,minute);
				break;
		}
		$('#cron-box').empty();
		for (let i in insert_arr){
			let item = insert_arr[i];
			$('#cron-box').append(item);
		}
		layui.form.render('select');
	}

</script>

</body>
</html>
